#!/usr/bin/env python
import optparse
import os
import sys

import nose

import stacktester.config
import stacktester.issues


def main():
    options, args = parse_options()
    stacktester.config.StackConfig._path = os.path.abspath(options.config)
    nose_argv = [sys.argv[0]]

    if options.verbose:
        nose_argv.append("-v")

    nose_argv.extend(args)
    status = run_nose_without_exiting(module="stacktester",
                                      argv=nose_argv,
                                      defaultTest="stacktester.tests")

    report_known_issues_in_tests(stacktester.tests)
    sys.exit(status)


def parse_options():
    parser = optparse.OptionParser()
    parser.add_option("-c", 
                      "--config", 
                      dest="config", 
                      metavar="FILE",
                      help="Load configuration from FILE.",
                      default="etc/stacktester.cfg")
    parser.add_option("-v",
                      "--verbose",
                      dest="verbose",
                      action="store_true",
                      help="Toggle verbose output.")
    return parser.parse_args()


def run_nose_without_exiting(*args, **kwargs):
    exit_status = None

    def save_exit_status(status):
        exit_status = status

    tmp_exit = sys.exit
    sys.exit = save_exit_status
    nose.main(*args, **kwargs)
    sys.exit = tmp_exit
    return exit_status


def report_known_issues_in_tests(module):
    finder = stacktester.issues.KnownIssuesFinder()
    finder.find_known_issues(module)
    report_known_issues(finder.count)


def report_known_issues(known_issues):
    if known_issues == 0:
        print "There were no known issues skipped."
    elif known_issues == 1:
        print "There was 1 known issue skipped."
    else:
        print "There were %d known issues skipped." % known_issues


if __name__ == "__main__":
    sys.exit(main())
